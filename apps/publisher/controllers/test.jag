<% require('/modules/publisher.js').exec(function(ctx) {
    // var log = new Log();
    // var userMod = require('store').user;
    // var userRegistry = userMod.userRegistry(ctx.session);
    // var govUtils = Packages.org.wso2.carbon.governance.api.util.GovernanceUtils;
    // var registry = userRegistry.registry;
    // var govRegistry = govUtils.getGovernanceUserRegistry(registry, registry.getUserName());
    // var results = govUtils.findGovernanceArtifacts("version=1.0.0&mediaType=application/vnd.wso2-gadget+xml", govRegistry, "application/vnd.wso2-gadget+xml");
    // print(results.size());
    // /*for(var key in results){
    //     log.info(key);
    // }*/
    // var iter = results.iterator();
    // var current;
    // while(iter.hasNext()){
    //     current = iter.next();
    // }
    // for(var key in current){
    //     log.info(key);
    // }
    var log = new Log();
    var server = require('store').server;
    var core = require('rxt').core;
    var sysRegistry = server.systemRegistry(-1234);
    //var typeCollection = sysRegistry.get('/_system/config/repository/components/org.wso2.carbon.governance/configuration');
    var path = '/_system/governance/repository/components/org.wso2.carbon.governance/types';
    var typeCollection = sysRegistry.get(path);
    var childCollections = typeCollection.content;
    var typeResource;
    var resource;
    var typeName = function(path) {
        path = String(path);
        var arr = path.split('/');
        var file = arr[arr.length - 1] || '';
        //log.info('file: '+file);
        return file.split('.')[0];
    };
    for (var index in childCollections) {
        typeResource = childCollections[index];
        resource = sysRegistry.get(typeResource);
        // log.info('path: '+typeResource);
        // log.info('type: '+typeName(typeResource));
        // log.info('last updated time: '+stringify(resource.updated));
    }
    log.info('Asset type map');
    log.info(core.assetTypeDeploymentTimeMap(-1234));
    log.info('Is asset type updated: ');
    log.info(core.isAssetTypesUpdated(-1234));
    var configs = core.configs(-1234);
    log.info('Time Map ');
    log.info(configs.assetTimeMap);
    var configs = core.configs(-1234);
    var timeMap = configs.assetTimeMap;
    var currentTimeMap = core.assetTypeDeploymentTimeMap(-1234);
    var updated = false;
    for (var key in timeMap) {
        log.info(timeMap[key].time + ' == ' + currentTimeMap[key].time);
        if (timeMap[key].time !== currentTimeMap[key].time) {
            updated = true;
        }
    }
    print("Hello world!");
}, request, response, session);
// var rxtAPI = require('rxt');
// var q = {};
// q.version = '1.0.0';
// var assets = rxtAPI.asset.advanceSearch(q,{},session);
// var log = new Log();
// log.info('Size of result set: '+assets.size());
// for(var key in assets){
//     log.info(key);
// }
//print(assets);
/*var rxtAPI = require('rxt');
var log = new Log();
var context = rxtAPI.core.createUserAssetContext(session, 'gadget');
var rxtManager = context.rxtManager;
var um = context.userManager;
var server = require('store').server;
var sysRegistry = server.systemRegistry(-1234);
var user1Role = 'Internal/private_user1';
var user2Role = 'Internal/private_user2';
var actions = ["http://www.wso2.org/projects/registry/actions/get", "http://www.wso2.org/projects/registry/actions/add", "http://www.wso2.org/projects/registry/actions/delete", "authorize"];
var everyone = 'Internal/everyone';

var testPath = '/_system/governance/testcollection/asset1';

if(!sysRegistry.exists(testPath)){
    sysRegistry.put(testPath,{collection:true});
}

// var path = rxtManager.getRxtStoragePath('soapservice');
// log.info('storage path is '+path);
// var staticStoragePath = function(path) {
//     //Split the path by /
//     var components = path.split('/');
//     var isStatic = true;
//     var component;
//     var path=[];
//     for(var index = 0; index < components.length && isStatic; index++){
//         component = components[index];
//         if(component.indexOf('@') <= -1){
//             path.push(component);
//         } else {
//             isStatic = false;
//         }
//     }
//     return path.join('/');
// };
var types = rxtManager.listRxtTypes();
var type;
for(var index = 0; index < types.length; index++){
    type = types[index];
    log.info('Static path is '+rxtManager.getStaticRxtStoragePath(type));
}*/
//log.info(rxtManager.rxtMap.gadget.storagePath);
//Assign permissions to the testcollection to all roles
// var obj = {};
// obj[testPath] = actions;
// um.authorizeRole(user1Role,obj);
// um.authorizeRole(user2Role,obj);
//Assign permissions to user1Role to collection testcollection/asset1
//var obj = {};
//obj[testPath] = actions;
//um.authorizeRole(user1Role,obj);
//Authorize the everyone role to all actions
// var obj = {};
// obj[testPath] = actions;
// um.authorizeRole(everyone,obj);
//Unauthorize the everyone role
//var obj = {};
//obj[testPath] = actions;
//um.denyRole(everyone,obj);
// log.info(um.roleExists('Internal/publisher'));
// log.info(um.roleExists('iii'));
// var testRole = 'es.store.anon.user';
// if(!um.roleExists(testRole)){
//     log.info('Creating test role '+testRole);
//     um.addRole(testRole,[],[]);
// }
// log.info(um.roleExists(testRole));
// var authorizer = um.authorizer;
// var server = require('store').server;
// var user = um.getUser('user1'); //server.current(session);
// log.info('#### ROLES ####');
// log.info(user.getRoles());
// log.info('###############');
// ///_system/governance/permission/es/apps/publisher/pages/splash
// var permissions = ['/permission/es/apps/publisher/pages/splash', 'fake','/permission/admin/configure','/permission/admin/login'];
// var isAuthorized;
// var permission;
// var action = 'ui.execute'; //'http://www.wso2.org/projects/registry/actions/get';
// var role = user.getRoles()[0];
// var isUserAuthorized;
// for (var index = 0; index < permissions.length; index++) {
//     permission = permissions[index];
//     isRoleAuthorized = authorizer.isRoleAuthorized(role, permission, action);
//     isUserAuthorized = authorizer.isUserAuthorized(user.username,permission,action);
//     log.info('### check '+index+' ###');
//     log.info('role: ' + role);
//     log.info('permission: ' + permission);
//     log.info('role authorized: ' + isRoleAuthorized);
//     log.info('user authorized: ' + isUserAuthorized);
//     log.info('#############');
// }
// var appResources = rxtAPI.app.getAppResources(-1234);
// log.info('##############');
// log.info(appResources);
// log.info('##############');
//rxtAPI.permissions.force(-1234);
// var permissions = rxtAPI.permissions;
// log.info('### Asset Check ###');
// log.info('*** user3 ***');
// log.info('Is authorized to view create page of SITES? '+permissions.hasAssetPermission('ASSET_CREATE','site',-1234,'user4'));
// log.info('Is authorized to view list page of SITES? '+permissions.hasAssetPermission('ASSET_LIST','site',-1234,'user4'));
// log.info('Is authorized to view lifecycle page of SITES? '+permissions.hasAssetPermission('ASSET_LIFECYCLE','site',-1234,'user4'));
// log.info('Is authorized to view create page of GADGETS? '+permissions.hasAssetPermission('ASSET_CREATE','gadget',-1234,'user4'));
// log.info('Is authorized to view list page of GADGETS? '+permissions.hasAssetPermission('ASSET_LIST','gadget',-1234,'user4'));
// log.info('Is authorized to view lifecycle page of GADGETS? '+permissions.hasAssetPermission('ASSET_LIFECYCLE','gadget',-1234,'user4'));
//log.info('*** admin ***');
// log.info('Is authorized to view create page of SITES? '+permissions.hasAssetPermission('ASSET_CREATE','site',session));
// log.info('Is authorized to view list page of SITES? '+permissions.hasAssetPermission('ASSET_LIST','site',session));
// log.info('Is authorized to view lifecycle page of SITES? '+permissions.hasAssetPermission('ASSET_LIFECYCLE','site',session));
// log.info('Is authorized to view create page of GADGETS? '+permissions.hasAssetPermission('ASSET_CREATE','gadget',session));
// log.info('Is authorized to view list page of GADGETS? '+permissions.hasAssetPermission('ASSET_LIST','gadget',session));
// log.info('Is authorized to view lifecycle page of GADGETS? '+permissions.hasAssetPermission('ASSET_LIFECYCLE','gadget',session));
//log.info('### App Check ###');
//isAuthorized = permissions.hasAppPermission('ASSET_COMMENTS',session);
//log.info('Is authorized '+isAuthorized);
// var log = new Log();
// var authorizer = um.authorizer;
// log.info('Printing authorizer methods ');
// for(var key in authorizer){
//     log.info('key: '+key);
// }
// log.info('Finished printing authorizer methods');
// //log.info(authorizer.allowedUIResourcesForUser('admin','/'));
// log.info(rxtAPI.app.getApiEndpoints(-1234));
//rxtAPI.permissions.force(-1234);
// rxtAPI.permissions.isAssetPageAccessible({
//     url:'outer',
//     username:'user2',
//     tenantId:-1234
// });
//var server = require('store').server;
//var systemRegistry = server.systemRegistry(-1234);
//recursivelyCreatePath('/_system/governance/permission/es/apps/publisher', systemRegistry);
// var rxtAPI = require('rxt');
// var constants = rxtAPI.constants;
// var core = rxtAPI.core;
// var log = new Log();
// var matchFile = function(fileName,dir){
//     var files = dir.listFiles();
//     var found = false;
//     for(var index = 0 ; (index <  files.length ) && (!found); index++){
//         if(files[index].getName() === fileName){
//             found = true;
//         }
//     }
//     return found;
// };
// var hasAppScript = function(dir){
//     return matchFile('app.js',dir);
// };
// var hasAssetScript = function(dir){
//     return matchFile('asset.js',dir);
// };
// var readScriptContent = function(file){
//     var content = '';
//     try{
//         file.open('r');
//         content = file.readAll();
//     } catch(e){
//         log.error('Unable to read contents of '+file.getPath()+' '+file.getName(),e);
//     } finally{
//         file.close();
//     }
//     return content;
// };
// var appExtensionPath = function(dir){
//     return dir.getPath()+'/app.js';
// };
// var assetExtensionPath = function(dir){
//     return dir.getPath()+'/asset.js';
// }
// var evalExtensionScript = function(dir){
//     var file = new File(appExtensionPath(dir));
//     var content = readScriptContent(file);
//     var script = 'function(app,log){' + content + '}';
//     var module = {};
//     var  l = new Log(file.getName());
//     var ptr;
//     module.dependencies = [];
//     ptr = eval(script);
//     ptr.call(this,module,l);
//     return module;
// };
//     function DefaultAppExtensionMediatorImpl(path){
//     this.path = path;
// }
// DefaultAppExtensionMediatorImpl.prototype.resolveCaramelResources = function(resourcePath,theme,caramelThemeResolver) {
//     var file;
//     var fullPath = this.path + '/' + resourcePath;
//     file = new File(fullPath);
//     if(file.isExists()){
//         return fullPath;
//     }
//     return caramelThemeResolver(theme, resourcePath);
// };
// function DefaultAppExtensionMediator(impl) {
//     this.impl = impl;
// }
// DefaultAppExtensionMediator.prototype.manager = function() {};
// DefaultAppExtensionMediator.prototype.renderer = function() {};
// DefaultAppExtensionMediator.prototype.configs = function() {};
// DefaultAppExtensionMediator.prototype.resolveCaramelResources = function(resourcePath,theme,caramelThemeResolver) {
//     var file;
//     var fullPath = this.path + '/' + resourcePath;
//     theme = theme || {};
//     caramelThemeResolver = caramelThemeResolver || function(theme,path) { return path};
//     if(!this.impl){
//         return caramelThemeResolver(theme,path);
//     }
//     return this.impl.resolveCaramelResources(resourcePath,theme,caramelThemeResolver);
// };
// var loadDefaultAppExtensions = function(){
//     //Go through each app extension 
//     var dirPath = '/extensions/app';
//     var dir = new File(dirPath);
//     var extensionDir;
//     var extensionDirs;
//     var extension;
//     var dependencies;
//     var mediator;
//     var mediatorImpl;
//     var ignore = false;
//     var found = false; //Assume that no default extensions will be found
//     if(!dir.isDirectory()){
//         log.error('Unable to read the app extension directory');
//         return;
//     }
//     extensionDirs = dir.listFiles() || [];
//     extensionDir;
//     for(var index = 0; index < extensionDirs.length ; index++){
//         extensionDir = extensionDirs [index];
//         log.info('checking extension: '+extensionDir.getName());
//         //Check if there is an asset script
//         if(hasAppScript(extensionDir)){
//             //Get the extension details
//             extension = evalExtensionScript(extensionDir);
//             dependencies = extension.dependencies || [];
//             ignore =  extension.ignoreExtension || false;
//             if(((dependencies.indexOf(constants.DEFAULT_APP_EXTENSION)>-1) && (!ignore))&&(found)){
//                 log.error('An extension which overrides the default asset extension was already loaded, thus app extension: '+extensionDir.getName()
//                     +' will be ignored.Please make sure that there is only one app extension which declares a dependency to "default".');
//             }
//             //Check if "default" is one of the dependencies
//             if(((dependencies.indexOf(constants.DEFAULT_APP_EXTENSION)>-1) && (!ignore))&&(!found)){
//                 log.info('found an app extension which overrides the default asset extension: '+extensionDir.getName());
//                 found = true;
//                 //Build a mediator
//                 mediatorImpl = new DefaultAppExtensionMediatorImpl(extensionDir.getPath());
//                 mediator = new DefaultAppExtensionMediator(mediatorImpl);
//                 core.defaultAppExtensionMediator(mediator);
//                 log.info('-> '+mediator.resolveCaramelResources('/apples'));
//             }
//         }
//     }
// };
// function DefaultAppExtensionMediatorImpl(path){
//     this.path = path;
//     this.assetExtension = {};
//     this.init();
// }
// DefaultAppExtensionMediatorImpl.prototype.resolveCaramelResources = function(resourcePath,theme,caramelThemeResolver) {
//     var file;
//     var fullPath = this.path + '/' + resourcePath;
//     file = new File(fullPath);
//     if(file.isExists()){
//         return fullPath;
//     }
//     return caramelThemeResolver(theme, resourcePath);
// };
// DefaultAppExtensionMediatorImpl.prototype.init = function(){
//     var extensionDir = new File(this.path);
//     var scriptFile = new File(assetExtensionPath(extensionDir));
//     var content = readScriptContent(scriptFile);
//     var extension = {};
//     var script = 'function(asset,log) { '+content+' } ';
//     var l = new Log();
//     var ptr = eval(script);
//     ptr.call(this,extension,l);
//     this.assetExtension = extension || {};
//     //log.info(this.assetExtension.renderer().pageDecorators);
// };
// DefaultAppExtensionMediatorImpl.prototype.manager = function(){
//     return this.assetExtension.manager;
// };
// DefaultAppExtensionMediatorImpl.prototype.renderer = function(){
//     return this.assetExtension.renderer;
// };
// function DefaultAppExtensionMediator(impl) {
//     this.impl = impl;
// }
// DefaultAppExtensionMediator.prototype.manager = function() {
//     if(!this.impl){
//         return null;
//     }
//     return this.impl.manager();
// };
// DefaultAppExtensionMediator.prototype.renderer = function() {
//     if(!this.impl){
//         return null;
//     }
//     return this.impl.renderer();
// };
// DefaultAppExtensionMediator.prototype.configs = function() {};
// DefaultAppExtensionMediator.prototype.resolveCaramelResources = function(resourcePath,theme,caramelThemeResolver) {
//     var file;
//     var fullPath = this.path + '/' + resourcePath;
//     theme = theme || {};
//     caramelThemeResolver = caramelThemeResolver || function(theme,path) { return path};
//     if(!this.impl){
//         return caramelThemeResolver(theme,path);
//     }
//     return this.impl.resolveCaramelResources(resourcePath,theme,caramelThemeResolver);
// };
// loadDefaultAppExtensions();
/*require('/modules/publisher.js').exec(function(ctx) {
    var storeAPI = require('store');
    var assetAPI = require('rxt').asset;
    var am = assetAPI.createUserAssetManager(session, 'servicex');
    var afm = am.am;
    var manager = afm.manager;
    var q = {};
    var log = new Log();


    //q.propertyName = 'default';
    //q.rightPropertyValue = true;
    //q.rightOp = 'eq';
    //q.leftOp = 'na';
    q._group = true;
    //q._wildcard = true;
    q.overview_provider='org.wso2';

    //q.resourcePath = '/_system/governance/servicesx/org.wso2/test-wso2-service/1.0.0';
    //q.overview_name='wso2';
    var defaultPaging = {
        'start': 0,
        'count': 1000,
        'sortOrder': 'desc',
        'sortBy': 'overview_createdtime',
        'paginationLimit': 1000
    };
    
    var result = am.search(q,defaultPaging);//am.getAssetGroup(q.overview_name,defaultPaging);//am.search(q,defaultPaging);

    log.info(result);
     */
// var HashMap = java.util.HashMap;
//    var ArrayList = java.util.ArrayList;
//    var map = new HashMap();
//    var propList = new ArrayList();
//    propList.add('default');
//    var rightPropertyList = new ArrayList();
//    rightPropertyList.add('true');
//    var rightOpList = ArrayList();
//    rightOpList.add('eq');
//    var leftOpList = ArrayList();
//    leftOpList.add('na');
//    map.put('propertyName',propList);
//    map.put('rightPropertyValue',rightPropertyList);
//    map.put('rightOp',rightOpList);
//    map.put('leftOp',leftOpList);
//    var artifacts = manager.findGenericArtifacts(map);
//    log.info(artifacts);
// var URL = 'https://na9.salesforce.com/services/data/v26.0/query/?q=SELECT+Id+FROM+Opportunity+WHERE+CreatedDate+>=+2015-02-01T00:00:00Z';
// var url = encodeURI(URL);
// var result = get(url);
// log.info(result);
%>